# Example GitLab CI configuration for Docker build
# Copy this to .gitlab-ci.yml and adjust as needed

stages:
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Build Docker image
build:
  stage: build
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - echo "=== Building Docker image and pushing to Azure Container Registry ==="
    - echo "ACR: $ACR_REGISTRY"
    - echo "Image: $ACR_REGISTRY/$APP_NAME:$CI_COMMIT_SHORT_SHA"
    - echo "Logging into Azure Container Registry..."
    - echo $ACR_PASSWORD | docker login $ACR_REGISTRY -u $ACR_USERNAME --password-stdin
  script:
    - |
      echo "=========================================="
      echo "üöÄ Building Docker image"
      echo "=========================================="
      echo "üìã Configuration:"
      echo "   Registry: $ACR_REGISTRY"
      echo "   Image: $APP_NAME"
      echo "   Commit SHA: $CI_COMMIT_SHORT_SHA"
      echo "   Full image: $ACR_REGISTRY/$APP_NAME:$CI_COMMIT_SHORT_SHA"
      echo ""
      echo "üßπ Cleaning up disk space before build..."
      docker system prune -f || true
      df -h
      echo ""
      echo "üì• Pulling previous image for cache (if exists)..."
      docker pull $ACR_REGISTRY/$APP_NAME:latest || echo "No previous image found, building from scratch"
      echo ""
      echo "üèóÔ∏è  Building Docker image with cache..."
      docker build \
        --cache-from $ACR_REGISTRY/$APP_NAME:latest \
        --tag $ACR_REGISTRY/$APP_NAME:$CI_COMMIT_SHORT_SHA \
        --tag $ACR_REGISTRY/$APP_NAME:latest \
        .
      echo ""
      echo "üì§ Pushing images to registry..."
      docker push $ACR_REGISTRY/$APP_NAME:$CI_COMMIT_SHORT_SHA
      docker push $ACR_REGISTRY/$APP_NAME:latest
      echo ""
      echo "‚úÖ Build and push completed!"
  after_script:
    - docker logout $ACR_REGISTRY || true
  only:
    - main
    - develop

# Optional: Deploy stage
# deploy:
#   stage: deploy
#   image: mcr.microsoft.com/azure-cli:latest
#   script:
#     - az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
#     - az acr import --name $ACR_REGISTRY --source $ACR_REGISTRY/$APP_NAME:$CI_COMMIT_SHORT_SHA
#   only:
#     - main

